<h1>Productos</h1>

<form method="GET" action="/products" style="margin-bottom:16px;">
    <input name="query" placeholder="categoria o available/unavailable" value="{{query}}" />
    <select name="sort">
        <option value="" {{#unless sort}}selected{{/unless}}>sin orden</option>
        <option value="asc" {{#if (eq sort "asc")}}selected{{/if}}>precio asc</option>
        <option value="desc" {{#if (eq sort "desc")}}selected{{/if}}>precio desc</option>
    </select>
    <input name="limit" type="number" min="1" value="{{limit}}" style="width:90px;" />
    <button type="submit">Aplicar</button>
</form>

{{#if products.length}}
    {{#each products}}
        <div class="card">
        <strong>{{title}}</strong> — ${{price}} — stock: {{stock}} — cat: {{category}}
        <div class="muted">{{description}}</div>

        <div style="margin-top:8px; display:flex; gap:10px; align-items:center;">
            <a href="/products/{{_id}}">Ver detalle</a>

            <button class="addToCartBtn" data-pid="{{_id}}">Agregar al carrito</button>
            <span class="muted" data-msg="{{_id}}"></span>
        </div>
        </div>
    {{/each}}
    {{else}}
    <p>No hay productos.</p>
{{/if}}

<div style="display:flex; gap:12px; margin-top:16px; align-items:center;">
    {{#if hasPrevPage}}
        <a href="/products?page={{prevPage}}&limit={{limit}}&sort={{sort}}&query={{query}}">⬅ Prev</a>
    {{/if}}

    <span>Página {{page}} / {{totalPages}}</span>

    {{#if hasNextPage}}
        <a href="/products?page={{nextPage}}&limit={{limit}}&sort={{sort}}&query={{query}}">Next ➡</a>
    {{/if}}
</div>

<script>
    const CART_ID = "PEGÁ_ACÁ_TU_CART_ID";

    document.addEventListener("click", async (e) => {
        const btn = e.target.closest(".addToCartBtn");
        if (!btn) return;

        if (!CART_ID || CART_ID.includes("PEGÁ_ACÁ")) {
        alert("Te falta pegar el CART_ID en index.handlebars (CART_ID = ...).");
        return;
        }

        const pid = btn.dataset.pid;
        const msgEl = document.querySelector(`[data-msg="${pid}"]`);
        if (msgEl) msgEl.textContent = "Agregando...";

        const res = await fetch(`/api/carts/${CART_ID}/product/${pid}`, { method: "POST" });
        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
        if (msgEl) msgEl.textContent = "❌ " + (data.error || "Error");
        return;
        }

        if (msgEl) msgEl.textContent = "✅ Agregado";
    });
</script>
